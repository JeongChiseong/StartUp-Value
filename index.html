import React, { useState, useRef, useCallback } from 'react';
import { Calculator, Download, TrendingUp, DollarSign, BarChart3, PieChart, Info } from 'lucide-react';

// 상수 정의
const CONSTANTS = {
  INDUSTRY_OPTIONS: [
    { value: 'HaaS', label: 'HaaS (하드웨어 서비스)', desc: '장비 임대+구독 모델' },
    { value: 'IoT/하드웨어', label: 'IoT/하드웨어', desc: '사물인터넷 및 하드웨어 제조' },
    { value: 'SaaS', label: 'SaaS', desc: '소프트웨어 서비스' },
    { value: 'E-commerce', label: 'E-commerce', desc: '전자상거래 플랫폼' },
    { value: '핀테크', label: '핀테크', desc: '금융기술 서비스' },
    { value: '헬스테크', label: '헬스테크', desc: '의료/건강 기술' }
  ],
  STAGE_OPTIONS: [
    { value: 'Pre-Revenue', label: 'Pre-Revenue', desc: '아직 매출 없음, 제품 개발 단계' },
    { value: 'Early Revenue', label: 'Early Revenue', desc: '초기 매출 발생, 시범 고객 확보' },
    { value: 'Growth', label: 'Growth', desc: '매출 급성장, 시장 확장 단계' },
    { value: 'Scale-up', label: 'Scale-up', desc: '안정적 매출, 규모 확대 단계' }
  ],
  DEFAULT_VALUES: {
    companyName: '사이러스바이크',
    industry: 'HaaS',
    stage: 'Early Revenue',
    investmentAmount: 40000,
    churnRate: 5
  }
};

// 유틸리티 함수들
const formatNumber = (num, decimals = 1) => {
  if (!num) return '0';
  return (num / 10000).toFixed(decimals);
};

const formatCurrency = (num) => {
  if (!num) return '0만원';
  return `${num.toLocaleString()}만원`;
};

// 밸류에이션 계산 로직
const calculateValuation = (data) => {
  const totalRevenue = (data.hardwareSales || 0) + (data.subscriptionRevenue || 0);
  const growthRate = data.revenueGrowthRate / 100;
  
  // HaaS 모델 특화 PSR 배수 계산
  let psrMultiple = 5;
  
  const subscriptionRatio = totalRevenue > 0 ? data.subscriptionRevenue / totalRevenue : 0;
  if (subscriptionRatio > 0.7) psrMultiple += 3;
  else if (subscriptionRatio > 0.5) psrMultiple += 2;
  else if (subscriptionRatio > 0.3) psrMultiple += 1;
  
  if (growthRate > 0.5) psrMultiple += 2;
  else if (growthRate > 0.3) psrMultiple += 1;
  else if (growthRate < 0) psrMultiple -= 1;
  
  const grossMargin = totalRevenue > 0 ? data.grossProfit / totalRevenue : 0;
  if (grossMargin > 0.7) psrMultiple += 2;
  else if (grossMargin > 0.5) psrMultiple += 1;
  
  psrMultiple = Math.max(psrMultiple, 2);
  
  const revenueValuation = totalRevenue * psrMultiple;
  
  // DCF 계산
  const year1Revenue = totalRevenue * (1 + growthRate);
  const year2Revenue = year1Revenue * (1 + growthRate * 0.8);
  const year3Revenue = year2Revenue * (1 + growthRate * 0.6);
  
  const netMargin = totalRevenue > 0 ? data.netIncome / totalRevenue : 0.15;
  const discountRate = 0.15;
  
  const dcfValue = (
    (year1Revenue * netMargin) / (1 + discountRate) +
    (year2Revenue * netMargin) / Math.pow(1 + discountRate, 2) +
    (year3Revenue * netMargin) / Math.pow(1 + discountRate, 3)
  );
  
  const finalValuation = Math.max((revenueValuation + dcfValue) / 2, totalRevenue * 2);
  
  return {
    revenueValuation,
    dcfValue,
    finalValuation,
    psrMultiple,
    totalRevenue,
    subscriptionRatio: subscriptionRatio * 100,
    netMargin: netMargin * 100,
    equityPercentage: (data.investmentAmount / (finalValuation + data.investmentAmount)) * 100,
    preMoney: finalValuation,
    postMoney: finalValuation + data.investmentAmount
  };
};

// 컴포넌트들
const InputField = ({ label, value, onChange, placeholder, type = 'number', helpText }) => (
  <div>
    <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
    <input
      type={type}
      value={value || ''}
      onChange={(e) => onChange(e.target.value)}
      className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
      placeholder={placeholder}
    />
    {helpText && <div className="text-xs text-gray-500 mt-1">{helpText}</div>}
  </div>
);

const SelectField = ({ label, value, onChange, options }) => (
  <div>
    <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
    <select
      value={value}
      onChange={(e) => onChange(e.target.value)}
      className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
    >
      {options.map(option => (
        <option key={option.value} value={option.value}>
          {option.label} {option.desc && `- ${option.desc}`}
        </option>
      ))}
    </select>
  </div>
);

const MetricCard = ({ label, value, bgColor, textColor = 'white' }) => (
  <div className={`${bgColor} p-4 rounded-lg text-${textColor}`}>
    <div className={`text-${textColor === 'white' ? 'gray-100' : 'gray-600'} text-sm mb-1`}>{label}</div>
    <div className="text-2xl font-bold">{value}</div>
  </div>
);

const DetailRow = ({ label, value }) => (
  <div className="flex justify-between items-center py-1">
    <span className="text-gray-600 text-sm">{label}</span>
    <span className="font-medium text-sm">{value}</span>
  </div>
);

const SectionCard = ({ title, icon: Icon, bgColor, children }) => (
  <div className={`${bgColor} p-4 rounded-lg`}>
    <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
      <Icon className="w-5 h-5" />
      {title}
    </h2>
    {children}
  </div>
);

const ValuationCalculator = () => {
  const [data, setData] = useState({
    ...CONSTANTS.DEFAULT_VALUES,
    hardwareSales: 0,
    subscriptionRevenue: 0,
    previousYearRevenue: 0,
    grossProfit: 0,
    netIncome: 0,
    totalAssets: 0,
    totalDebt: 0,
    customerCount: 0,
    avgContractValue: 0,
    revenueGrowthRate: 0
  });

  const resultRef = useRef(null);

  const handleInputChange = useCallback((field, value) => {
    setData(prevData => {
      const newData = { ...prevData, [field]: parseFloat(value) || 0 };
      
      // 성장률 자동 계산
      if (['hardwareSales', 'subscriptionRevenue', 'previousYearRevenue'].includes(field)) {
        const currentTotalRevenue = (newData.hardwareSales || 0) + (newData.subscriptionRevenue || 0);
        if (currentTotalRevenue && newData.previousYearRevenue) {
          newData.revenueGrowthRate = ((currentTotalRevenue - newData.previousYearRevenue) / newData.previousYearRevenue * 100);
        }
      }
      
      return newData;
    });
  }, []);

  const results = calculateValuation(data);

  const downloadAsImage = useCallback(() => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = 1200;
    canvas.height = 900;
    
    // 배경 그라디언트
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#f8fafc');
    gradient.addColorStop(1, '#e2e8f0');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // 제목
    ctx.fillStyle = '#1e293b';
    ctx.font = 'bold 36px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${data.companyName} 밸류에이션 분석`, canvas.width/2, 60);
    
    // 부제목
    ctx.font = '18px Arial';
    ctx.fillStyle = '#64748b';
    ctx.fillText(`분석일: ${new Date().toLocaleDateString('ko-KR')} | 업종: ${data.industry} | 단계: ${data.stage}`, canvas.width/2, 90);
    
    // 메인 지표들
    const mainMetrics = [
      { label: '기업가치 (Pre-money)', value: `${formatNumber(results.preMoney)}억원`, color: '#059669', x: 100, y: 140 },
      { label: '투자 후 가치 (Post-money)', value: `${formatNumber(results.postMoney)}억원`, color: '#0d9488', x: 650, y: 140 },
      { label: '취득 지분율', value: `${results.equityPercentage.toFixed(1)}%`, color: '#dc2626', x: 100, y: 240 },
      { label: '총 연매출', value: `${formatNumber(results.totalRevenue)}억원`, color: '#7c3aed', x: 650, y: 240 }
    ];
    
    mainMetrics.forEach(metric => {
      ctx.fillStyle = metric.color;
      ctx.fillRect(metric.x, metric.y, 450, 80);
      
      ctx.fillStyle = 'white';
      ctx.font = 'bold 20px Arial';
      ctx.textAlign = 'left';
      ctx.fillText(metric.label, metric.x + 20, metric.y + 30);
      
      ctx.font = 'bold 28px Arial';
      ctx.fillText(metric.value, metric.x + 20, metric.y + 60);
    });
    
    // 상세 분석
    ctx.fillStyle = '#1e293b';
    ctx.font = 'bold 28px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('상세 분석', 100, 380);
    
    const details = [
      `매출 배수법 (PSR): ${formatNumber(results.revenueValuation)}억원 (${results.psrMultiple.toFixed(1)}배)`,
      `현금흐름법 (DCF): ${formatNumber(results.dcfValue)}억원`,
      `구독 매출 비중: ${results.subscriptionRatio.toFixed(1)}%`,
      `매출 성장률: ${data.revenueGrowthRate.toFixed(1)}%`,
      `순이익률: ${results.netMargin.toFixed(1)}%`,
      `주당 가치: ${(results.preMoney/400).toFixed(0)}원 (400만주 가정)`
    ];
    
    ctx.font = '20px Arial';
    ctx.fillStyle = '#475569';
    details.forEach((detail, index) => {
      ctx.fillText(detail, 100, 420 + index * 35);
    });
    
    // 투자 조건
    ctx.fillStyle = '#1e293b';
    ctx.font = 'bold 28px Arial';
    ctx.fillText('투자 조건 요약', 100, 650);
    
    const investmentDetails = [
      `투자금액: ${formatNumber(data.investmentAmount)}억원`,
      `취득지분: ${results.equityPercentage.toFixed(1)}%`,
      `전환가격: ${(data.investmentAmount*10000/(results.equityPercentage*4)).toFixed(0)}원/주`
    ];
    
    ctx.font = '20px Arial';
    ctx.fillStyle = '#059669';
    investmentDetails.forEach((detail, index) => {
      ctx.fillText(detail, 100, 690 + index * 35);
    });
    
    // 워터마크
    ctx.fillStyle = '#94a3b8';
    ctx.font = '14px Arial';
    ctx.textAlign = 'right';
    ctx.fillText('Startup Valuation Calculator v1.0', canvas.width - 20, canvas.height - 20);
    
    // 다운로드
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${data.companyName}_밸류에이션_${new Date().toISOString().slice(0,10)}.png`;
      a.click();
      URL.revokeObjectURL(url);
    });
  }, [data, results]);

  const totalRevenue = (data.hardwareSales || 0) + (data.subscriptionRevenue || 0);

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
      <div className="max-w-7xl mx-auto p-6">
        {/* 헤더 */}
        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
          <div className="flex items-center gap-3 mb-4">
            <Calculator className="w-10 h-10 text-blue-600" />
            <div>
              <h1 className="text-4xl font-bold text-gray-800">스타트업 밸류에이션 계산기</h1>
              <p className="text-gray-600 mt-1">재무제표 기반 정확한 기업가치 산정</p>
            </div>
          </div>
          
          <div className="flex items-center gap-2 text-sm text-blue-600 bg-blue-50 p-3 rounded-lg">
            <Info className="w-4 h-4" />
            <span>HaaS(Hardware as a Service) 모델에 최적화된 밸류에이션 엔진</span>
          </div>
        </div>

        <div className="grid grid-cols-1 xl:grid-cols-5 gap-6">
          {/* 입력 섹션 (3/5) */}
          <div className="xl:col-span-3 space-y-6">
            {/* 기본 정보 */}
            <SectionCard title="기본 정보" icon={BarChart3} bgColor="bg-white shadow-lg">
              <div className="space-y-4">
                <InputField
                  label="회사명"
                  value={data.companyName}
                  onChange={(value) => handleInputChange('companyName', value)}
                  type="text"
                  placeholder="사이러스바이크"
                />
                <div className="grid grid-cols-2 gap-4">
                  <SelectField
                    label="업종"
                    value={data.industry}
                    onChange={(value) => handleInputChange('industry', value)}
                    options={CONSTANTS.INDUSTRY_OPTIONS}
                  />
                  <SelectField
                    label="성장 단계"
                    value={data.stage}
                    onChange={(value) => handleInputChange('stage', value)}
                    options={CONSTANTS.STAGE_OPTIONS}
                  />
                </div>
              </div>
            </SectionCard>

            {/* 재무 데이터 */}
            <SectionCard title="재무 데이터 (연간, 만원)" icon={DollarSign} bgColor="bg-white shadow-lg">
              <div className="space-y-6">
                {/* 매출 구성 */}
                <div className="border-l-4 border-green-500 pl-4 bg-green-50 p-4 rounded">
                  <h3 className="font-semibold text-green-700 mb-3">매출 구성</h3>
                  <div className="grid grid-cols-2 gap-4">
                    <InputField
                      label="하드웨어 판매 매출"
                      value={data.hardwareSales}
                      onChange={(value) => handleInputChange('hardwareSales', value)}
                      placeholder="20000"
                      helpText="장비 판매/임대보증금 등 일회성 수익"
                    />
                    <InputField
                      label="구독/서비스 매출"
                      value={data.subscriptionRevenue}
                      onChange={(value) => handleInputChange('subscriptionRevenue', value)}
                      placeholder="30000"
                      helpText="월 구독료, 플랫폼 이용료 등 반복 수익"
                    />
                  </div>
                  <div className="mt-3 p-3 bg-green-100 rounded">
                    <strong>총 연매출: {formatCurrency(totalRevenue)}</strong>
                  </div>
                </div>

                {/* 비교 데이터 */}
                <div className="border-l-4 border-blue-500 pl-4 bg-blue-50 p-4 rounded">
                  <h3 className="font-semibold text-blue-700 mb-3">성장률 계산</h3>
                  <InputField
                    label="전년도 총매출"
                    value={data.previousYearRevenue}
                    onChange={(value) => handleInputChange('previousYearRevenue', value)}
                    placeholder="25000"
                    helpText={`현재 성장률: ${data.revenueGrowthRate.toFixed(1)}% (자동계산)`}
                  />
                </div>

                {/* 손익 정보 */}
                <div className="grid grid-cols-2 gap-4">
                  <InputField
                    label="총 이익 (연간)"
                    value={data.grossProfit}
                    onChange={(value) => handleInputChange('grossProfit', value)}
                    placeholder="35000"
                    helpText="매출 - 제조원가"
                  />
                  <InputField
                    label="순 이익 (연간)"
                    value={data.netIncome}
                    onChange={(value) => handleInputChange('netIncome', value)}
                    placeholder="15000"
                    helpText="최종 순이익 (세전)"
                  />
                </div>
              </div>
            </SectionCard>

            {/* 운영 지표 */}
            <SectionCard title="운영 지표 & 투자 정보" icon={TrendingUp} bgColor="bg-white shadow-lg">
              <div className="grid grid-cols-2 gap-4">
                <InputField
                  label="계약 고객 수"
                  value={data.customerCount}
                  onChange={(value) => handleInputChange('customerCount', value)}
                  placeholder="50"
                  helpText="현재 계약 중인 고객사/학교 수"
                />
                <InputField
                  label="월평균 고객당 수익 (만원)"
                  value={data.avgContractValue}
                  onChange={(value) => handleInputChange('avgContractValue', value)}
                  placeholder="60"
                  helpText="고객 1개당 월 구독료/임대료"
                />
                <InputField
                  label="연간 이탈률 (%)"
                  value={data.churnRate}
                  onChange={(value) => handleInputChange('churnRate', value)}
                  placeholder="5"
                  helpText="1년간 계약 해지 고객 비율"
                />
                <InputField
                  label="투자 유치 목표 (만원)"
                  value={data.investmentAmount}
                  onChange={(value) => handleInputChange('investmentAmount', value)}
                  placeholder="40000"
                  helpText="이번 라운드 투자금 (시드/시리즈A)"
                />
              </div>
            </SectionCard>
          </div>

          {/* 결과 섹션 (2/5) */}
          <div className="xl:col-span-2 space-y-6" ref={resultRef}>
            {/* 메인 결과 */}
            <SectionCard title="밸류에이션 결과" icon={PieChart} bgColor="bg-gray-800 text-white shadow-xl">
              <div className="space-y-4">
                <MetricCard
                  label="기업가치 (Pre-money)"
                  value={`${formatNumber(results.preMoney)}억원`}
                  bgColor="bg-green-600"
                />
                <MetricCard
                  label="투자 후 가치 (Post-money)"
                  value={`${formatNumber(results.postMoney)}억원`}
                  bgColor="bg-blue-600"
                />
                <MetricCard
                  label="취득 지분율"
                  value={`${results.equityPercentage.toFixed(1)}%`}
                  bgColor="bg-red-600"
                />
              </div>
            </SectionCard>

            {/* 상세 분석 */}
            <div className="bg-white p-6 rounded-lg shadow-lg">
              <h3 className="text-lg font-semibold mb-4 text-gray-800">상세 분석</h3>
              <div className="space-y-2">
                <DetailRow label="총 연매출" value={`${formatNumber(results.totalRevenue)}억원`} />
                <DetailRow label="구독매출 비중" value={`${results.subscriptionRatio.toFixed(1)}%`} />
                <DetailRow label="매출 성장률" value={`${data.revenueGrowthRate.toFixed(1)}%`} />
                <DetailRow label="순이익률" value={`${results.netMargin.toFixed(1)}%`} />
                <DetailRow label="PSR 배수" value={`${results.psrMultiple.toFixed(1)}배`} />
                <DetailRow label="PSR 밸류에이션" value={`${formatNumber(results.revenueValuation)}억원`} />
                <DetailRow label="DCF 밸류에이션" value={`${formatNumber(results.dcfValue)}억원`} />
              </div>
            </div>

            {/* 투자 조건 */}
            <div className="bg-indigo-50 p-6 rounded-lg border border-indigo-200">
              <h3 className="text-lg font-semibold text-indigo-800 mb-4">투자 조건 요약</h3>
              <div className="space-y-2">
                <DetailRow label="투자금액" value={`${formatNumber(data.investmentAmount)}억원`} />
                <DetailRow label="취득지분" value={`${results.equityPercentage.toFixed(1)}%`} />
                <DetailRow label="주당가치" value={`${(results.preMoney/400).toFixed(0)}원`} />
                <DetailRow label="전환가격" value={`${(data.investmentAmount*10000/(results.equityPercentage*4)).toFixed(0)}원`} />
              </div>
            </div>

            {/* 다운로드 버튼 */}
            <button
              onClick={downloadAsImage}
              className="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-4 px-6 rounded-lg flex items-center justify-center gap-3 transition-all duration-200 shadow-lg hover:shadow-xl"
            >
              <Download className="w-5 h-5" />
              결과 리포트 다운로드
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ValuationCalculator;
